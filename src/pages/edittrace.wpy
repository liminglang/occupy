<style lang="less">
  .startbutton {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .button {
    display:inline;
    background-color: #44dd15;
    margin-left: 200px;
  }
  .content {
    flex: 1;
    margin-left: 10px;
    text-overflow:ellipsis;
  }
  .gps {
    height: 30px;
    width: 30px;
  }
  .up-pic {
    width: 100%;
    justify-content: center;
  }
  .pic-box{  
    margin-top:20rpx;  
    flex-flow:wrap;  
    width:95%;   
  } 
  .ap-box{  
    position: relative;  
  }
  .add-pic{  
    width: 160rpx;  
    height: 160rpx;  
    margin-right: 20rpx;  
    position: relative;  
    margin: 20rpx 30rpx 20rpx 30rpx;  
  } 
  .img-de{  
    width:45rpx;  
    height:45rpx;  
    border-radius:50%;  
    position:absolute;  
    right:-41rpx;  
    top:5rpx;  
  }
</style>
<template>
  <view>
    <view>
      <view>新增足迹<button class='button' @tap="confirm">完成</button>
      </view>
      <!-- <view class="weui-cell weui-cell_input">
        <view class="weui-cell__hd">
          <view class="weui-label">省 市 区:</view>
        </view>
        <view class="weui-cell__bd">
          <picker mode="region" bindchange="bindRegionChange" value="{{region}}" custom-item="{{customItem}}">
            <view class="weui-input">{{region}}</view>
          </picker>
        </view>
      </view> -->
      <view class="weui-cell weui-cell_input">
        <view class="weui-cell__hd">
          <view class="weui-label">地点名称：</view>
        </view>
        <view class="weui-cell__bd">
          <view class="weui-input" @tap='searchLocation'>{{scenic}}</view>
          <!-- <input class="weui-input" value="{{scenic}}" bindfocus='searchLocation'/> -->
        </view>
      </view>
      <view class="weui-cell weui-cell_input">
        <view class="weui-cell__hd">
          <view class="weui-label">游玩日期:</view>
        </view>
        <view class="weui-cell__bd">
          <picker mode="date" bindchange="bindDateChange" value="{{date}}">
            <view class="weui-input" placeholder="选择到哪的时间">{{date}}</view>
          </picker>
        </view>
      </view>
      <view class='up-pic'>
        <view class='flex pic-box'>
          <block wx:key="imgbox" wx:for="{{imgbox}}">
            <view class='ap-box'>
              <view class='add-pic'>
                <image class='add-pic' src='{{item}}'></image>
                  <view class='img-de' data-deindex='{{index}}' bindtap='imgDelete'>
                    <image class='gps' src='/static/images/close_pic.png'></image>
                  </view>
              </view>
            </view>
          </block>
          <view class='add-pic' bindtap='uploadPhoto' wx:if="{{imgbox.length<9}}">
            <image class='gps' src='/static/images/add_pic.png'></image>
          </view>
        </view>
      </view>
      <view>隐藏足迹</view>
      <repeat for="{{list}}" key="index" index="index" item="item">
        <view class="weui-cell">
          <block wx:if='{{item.isshow}}'>
            <view class='content'>{{item.dateString}},{{item.city}},{{item.scenic}}
              <button class='button' @tap='hideTrace({{index}})'>隐藏</button>
            </view>
          </block>
          <block wx:else>
            <view class='content' style='color:#C0C0C0'>{{item.dateString}},{{item.city}},{{item.scenic}}
              <button class='button' @tap='hideTrace({{index}})'>显示</button>
            </view>
          </block>
        </view>
      </repeat>
    </view>   
  </view>
</template>
<script>
  import wepy from 'wepy'
  import 'wepy-async-function'
  import { baseUrl, appId} from '@/config'
  import req from '@/network'
  import qqmapwx from '../map/qqmap-wx-jssdk.js'
  export default class Edittrace extends wepy.page {
    config = {
      navigationBarTitleText: '足迹占领'
    }
    data = {
      date:'',
      imgbox:[],
      latitude:'',
      longitude:'',
      province:'',
      scenic:'',
      city:'',
      list:[],
      buttonContent:''
    }
    bindDateChange(e) {
      this.date = e.detail.value;
    }
    async onLoad(e) {
      if(e.latitude){
        this.latitude = e.latitude;
        this.longitude = e.longitude;
        this.scenic = e.scenic;
        this.province = e.province;
        this.city = e.city;
        this.$apply();
      }
      let url = baseUrl + `/trace/getMyTraces?userId=${this.$parent.globalData.user.id}`;
      const traces = await req.get(url).catch((err)=>{
        console.log("updateAvatarError...", err.data)})
      if (traces.data) {
        this.list = traces.data.data;
        for(let i=0;i<this.list.length;i++){
          let date  = new Date(this.list[i].created*1000);
          let year = date.getFullYear();
          let month = date.getMonth()+1;
          let day = date.getDate();
          this.list[i]['dateString'] = year + '.' + month + '.' + day;
        }
        this.$apply();
      }
    }

    methods = {     
      searchLocation(){
        wepy.navigateTo({url:`/pages/selectlocation`})
      },
      async uploadPhoto(e){
        let self = this;
        wx.showActionSheet({
          itemList: ['从相册中选择', '拍照'],
          success: async (res)=> {
            if (!res.cancel) {
              var imgbox = self.imgbox;
              console.log(imgbox)
              var picid = e.currentTarget.dataset.pic;
              console.log(picid)
              var that = this;
              var n = 9;
              if (9 > imgbox.length > 0) {
                n = 9 - imgbox.length;
              } else if (imgbox.length == 9) {
                n = 1;
              }
              const res = await wepy.chooseImage({
                count: n,
                sizeType: ['original', 'compressed'],
                sourceType: ['album', 'camera']
              })
              if (imgbox.length == 0) {
                imgbox = res.tempFilePaths
              } else if (9 > imgbox.length) {
                imgbox = imgbox.concat(res.tempFilePaths);
              } else {
                imgbox[picid] = res.tempFilePaths[0];
              }
              self.imgbox = imgbox;
              self.$apply();
            }
          }
        })
        this.$apply();
      },
      
      imgDelete(e){
        let index = e.currentTarget.dataset.deindex;
        this.imgbox.splice(index, 1);
        this.$apply();
      },

      async confirm(e) {
        const userInfo = e.detail.userInfo;
        console.log(userInfo)
        if (userInfo) {
          if (!this.$parent.globalData.userInfo) {
            const setting = await wepy.getSetting()
            if (setting.authSetting['scope.userInfo']) {
              const info = await wepy.getUserInfo()
              this.$parent.globalData.userInfo = info.userInfo
              let url = baseUrl + '/auth/updateUser'
              const setData = {'id':this.$parent.globalData.user.id, 'name': info.userInfo.nickName, 'avatar': info.userInfo.avatarUrl, 'gender': info.userInfo.gender}
              await req.post(url, setData).catch((err)=>{
                console.log("updateAvatarError...", err.data)})
              this.$parent.globalData.user.name = info.userInfo.nickName;
              this.$parent.globalData.user.avatar = info.userInfo.avatarUrl;
            }
          }         
        }
        
        let url = baseUrl + '/trace/addTrace';
        const setData = {'userId':this.$parent.globalData.user.id, 'latitude': this.latitude, 'longitude': this.longitude, 'scenic': this.scenic, 'province':this.province, 'city':this.city}
        const result = await req.post(url, setData).catch((err)=>{
          console.log("updateAvatarError...", err.data)})
        if(result.data.data.traceId){
          let self = this;
          let imgurl = baseUrl + `/image/save`
          for(var i = 0; i<this.imgbox.length ; i++){
            (function(i){
              wx.uploadFile({
                url: baseUrl + `/image/save?traceId=${result.data.data.traceId}`,
                filePath: self.imgbox[i],
                name: 'image',
                formData:{'number':i},
                header: {
                  'content-type':'multipart/form-data'
              },
                success(res){
                  console.log(res)
                }
              })
            })(i)
          }   
        }
        this.imgbox = [];
        this.scenic = '';
        this.date = '';
        this.$apply();
      },
      async hideTrace(index,id,isshow){
        console.log(this.list[index])
        let url = baseUrl + `/trace/updateTrace?id=${this.list[index].id}`
        if(this.list[index].isshow){
          this.list[index].isshow = 0;
        }else{
          this.list[index].isshow = 1;
        }
        const setData = {'isshow': this.list[index].isshow}
        await req.post(url, setData).catch((err)=>{
          console.log("updateAvatarError...", err.data)})
        this.$apply();
      }
    }
  }
</script>